(function(){"use strict";function U(p){return p&&p.__esModule&&Object.prototype.hasOwnProperty.call(p,"default")?p.default:p}var O={exports:{}},R;function k(){return R||(R=1,(function(p){var u=u||{REVISION:"ALPHA"};(function(g){var M=function(s,t){if(!s)throw t||"Assertion failed"},T=function(s,t,n){return s.hasOwnProperty(t)?s[t]:n},P=!1,X=0,L=function(){if(P)return P=!1,X;var s=2*Math.random()-1,t=2*Math.random()-1,n=s*s+t*t;if(n==0||n>1)return L();var i=Math.sqrt(-2*Math.log(n)/n);return X=t*i,P=!0,s*i},S=function(s,t){return s+L()*t},m=function(s){if(typeof s>"u"||isNaN(s))return[];if(typeof ArrayBuffer>"u"){for(var t=new Array(s),n=0;n<s;n++)t[n]=0;return t}else return new Float64Array(s)},_=function(s,t,n){for(var i=typeof n<"u",a=[],r=0;r<s;r++){for(var e=[],o=0;o<t;o++)i?e.push(n):e.push(S(0,1e-4));a.push(e)}return a},N=function(s,t){for(var n=s.length,i=0,a=0;a<n;a++){var r=s[a],e=t[a];i+=(r-e)*(r-e)}return i},C=function(s){for(var t=s.length,n=m(t*t),i=0;i<t;i++)for(var a=i+1;a<t;a++){var r=N(s[i],s[a]);n[i*t+a]=r,n[a*t+i]=r}return n},A=function(s,t,n){var i=Math.sqrt(s.length),a=Math.floor(i);M(a===i,"D should have square number of elements.");for(var r=Math.log(t),e=m(a*a),o=m(a),v=0;v<a;v++){for(var c=-1/0,h=1/0,l=1,y=!1,D=50,I=0;!y;){for(var Y=0,f=0;f<a;f++){var d=Math.exp(-s[v*a+f]*l);v===f&&(d=0),o[f]=d,Y+=d}for(var x=0,f=0;f<a;f++){var d=o[f]/Y;o[f]=d,d>1e-7&&(x-=d*Math.log(d))}x>r?(c=l,h===1/0?l=l*2:l=(l+h)/2):(h=l,c===-1/0?l=l/2:l=(l+c)/2),I++,Math.abs(x-r)<n&&(y=!0),I>=D&&(y=!0)}for(var f=0;f<a;f++)e[v*a+f]=o[f]}for(var G=m(a*a),B=a*2,v=0;v<a;v++)for(var f=0;f<a;f++)G[v*a+f]=Math.max((e[v*a+f]+e[f*a+v])/B,1e-100);return G};function w(s){return s>0?1:s<0?-1:0}var E=function(t){var t=t||{};this.perplexity=T(t,"perplexity",30),this.dim=T(t,"dim",2),this.epsilon=T(t,"epsilon",10),this.iter=0};E.prototype={initDataRaw:function(s){var t=s.length,n=s[0].length;M(t>0," X is empty? You must have some data!"),M(n>0," X[0] is empty? Where is the data?");var i=C(s);this.P=A(i,this.perplexity,1e-4),this.N=t,this.initSolution()},initDataDist:function(s){var t=s.length;M(t>0," X is empty? You must have some data!");for(var n=m(t*t),i=0;i<t;i++)for(var a=i+1;a<t;a++){var r=s[i][a];n[i*t+a]=r,n[a*t+i]=r}this.P=A(n,this.perplexity,1e-4),this.N=t,this.initSolution()},initSolution:function(){this.Y=_(this.N,this.dim),this.gains=_(this.N,this.dim,1),this.ystep=_(this.N,this.dim,0),this.iter=0},getSolution:function(){return this.Y},step:function(){this.iter+=1;for(var s=this.N,t=this.costGrad(this.Y),n=t.cost,i=t.grad,a=m(this.dim),r=0;r<s;r++)for(var e=0;e<this.dim;e++){var o=i[r][e],v=this.ystep[r][e],c=this.gains[r][e],h=w(o)===w(v)?c*.8:c+.2;c<.01&&(c=.01),this.gains[r][e]=h;var l=this.iter<250?.5:.8,y=l*v-this.epsilon*h*i[r][e];this.ystep[r][e]=y,this.Y[r][e]+=y,a[e]+=this.Y[r][e]}for(var r=0;r<s;r++)for(var e=0;e<this.dim;e++)this.Y[r][e]-=a[e]/s;return n},debugGrad:function(){var s=this.N,t=this.costGrad(this.Y);t.cost;for(var n=t.grad,i=1e-5,a=0;a<s;a++)for(var r=0;r<this.dim;r++){var e=this.Y[a][r];this.Y[a][r]=e+i;var o=this.costGrad(this.Y);this.Y[a][r]=e-i;var v=this.costGrad(this.Y),c=n[a][r],h=(o.cost-v.cost)/(2*i);console.log(a+","+r+": gradcheck analytic: "+c+" vs. numerical: "+h),this.Y[a][r]=e}},costGrad:function(s){for(var t=this.N,n=this.dim,i=this.P,a=this.iter<100?4:1,r=m(t*t),e=0,o=0;o<t;o++)for(var v=o+1;v<t;v++){for(var c=0,h=0;h<n;h++){var l=s[o][h]-s[v][h];c+=l*l}var y=1/(1+c);r[o*t+v]=y,r[v*t+o]=y,e+=2*y}for(var D=t*t,I=m(D),Y=0;Y<D;Y++)I[Y]=Math.max(r[Y]/e,1e-100);for(var f=0,d=[],o=0;o<t;o++){for(var x=new Array(n),h=0;h<n;h++)x[h]=0;for(var v=0;v<t;v++){f+=-i[o*t+v]*Math.log(I[o*t+v]);for(var G=4*(a*i[o*t+v]-I[o*t+v])*r[o*t+v],h=0;h<n;h++)x[h]+=G*(s[o][h]-s[v][h])}d.push(x)}return{cost:f,grad:d}}},g.tSNE=E})(u),(function(g){p.exports=g})(u)})(O)),O.exports}var F=k(),Q=U(F);const{tSNE:q}=Q,V=new Map;function z(p){if(!p)return[];if(V.has(p))return V.get(p);const u=p.split("|").map(g=>g.trim().toLowerCase()).filter(g=>g.length>0);return V.set(p,u),u}self.onmessage=function(p){const{books:u}=p.data;if(!u||u.length<3){self.postMessage({tsneCoords:{},done:!0});return}try{const g=new Map,M=[];for(let r=0;r<u.length;r++){const e=z(u[r].Temas);M.push(e);for(const o of e)g.set(o,(g.get(o)||0)+1)}const P=Array.from(g.entries()).sort((r,e)=>e[1]-r[1]).slice(0,60).map(([r])=>r),X=new Map(P.map((r,e)=>[r,e])),L=P.length,S=new Array(u.length);for(let r=0;r<u.length;r++){const e=new Uint8Array(L),o=M[r];for(const v of o){const c=X.get(v);c!==void 0&&(e[c]=1)}S[r]=Array.from(e)}const m=u.length,_=Math.min(20,Math.max(5,Math.floor(m/5)));let N;m<10?N=150:m<50?N=200:m<200?N=250:N=Math.min(300,Math.max(200,Math.floor(4e5/m)));const C=new q({dim:2,perplexity:_,epsilon:10});C.initDataRaw(S);for(let r=0;r<N;r++)C.step();const A=C.getSolution();let w=Number.MAX_VALUE,E=-Number.MAX_VALUE,s=Number.MAX_VALUE,t=-Number.MAX_VALUE;for(let r=0;r<A.length;r++){const e=A[r][0],o=A[r][1];e<w&&(w=e),e>E&&(E=e),o<s&&(s=o),o>t&&(t=o)}const n=E-w||1,i=t-s||1,a={};for(let r=0;r<u.length;r++){const[e,o]=A[r];a[u[r].id]=[(e-w)/n*90+5,(o-s)/i*90+5]}self.postMessage({tsneCoords:a,done:!0})}catch(g){self.postMessage({tsneCoords:{},done:!0,error:g.message})}}})();
